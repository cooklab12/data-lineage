<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Lineage Visualization</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f4f8;
        }
        #controls {
            position: fixed;
            top: 10px;
            left: 10px;
            z-index: 1000;
            background-color: rgba(255, 255, 255, 0.8);
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        #lineage-container {
            display: grid;            
            grid-template-columns: repeat(4, minmax(0, 1fr));
            grid-auto-rows: minmax(0, auto);
            gap: 50px;
            padding: 20px;
            transition: transform 0.3s ease;
        }
        .task-container {
            background-color: white;
            border: 1px solid #d1d5db;
            border-radius: 5px;
            padding: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .task-container h3 {
            margin-top: 0;
            padding-bottom: 5px;
            border-bottom: 1px solid #e5e7eb;
            color: #1f2937;
        }
        .column {
            cursor: pointer;
            padding: 5px;
            margin: 2px 0;
            border-radius: 3px;
            transition: background-color 0.2s ease;
        }
        .column:hover {
            background-color: #e5e7eb;
        }
        .highlighted {
            background-color: #fef3c7;
            font-weight: bold;
        }
        .task-highlighted {
            box-shadow: 0 0 10px #3b82f6;
        }
        svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        .connector {
            fill: none;
            stroke: #3b82f6;
            stroke-width: 2;
            opacity: 0.7;
        }
        .task-connector {
            fill: none;
            stroke-width: 3;
            opacity: 0.5;
        }
        button {
            background-color: #3b82f6;
            color: white;
            border: none;
            padding: 5px 10px;
            margin: 0 5px;
            border-radius: 3px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        button:hover {
            background-color: #2563eb;
        }
    </style>
</head>
<body>
    <div id="controls">
        <button onclick="zoomIn()">Zoom In</button>
        <button onclick="zoomOut()">Zoom Out</button>
        <button onclick="resetZoom()">Reset Zoom</button>
    </div>
    <div id="lineage-container">
        <svg id="connector-svg"></svg>
        <!-- Tasks will be dynamically added here -->
    </div>

    <script>
        const lineageData = {
            "FILE_NAME": [
                {
                    "task_number": "E1",
                    "taskNm": "extract",
                    "srcType": "file",
                    "compNm": "main",
                    "columnList": "col1,col2,col3",
                    "level" : "1",
                    "sequence" : "1"
                },
                {
                    "task_number": "E2",
                    "taskNm": "extract",
                    "srcType": "Oracle",
                    "compNm": "TRF",
                    "columnList": "col4",
                    "level" : "1",
                    "sequence" : "2"
                },
                {
                    "task_number": "E3",
                    "taskNm": "extract",
                    "srcType": "HBase",
                    "compNm": "TRF2",
                    "columnList": "col5,col6",
                    "level" : "1",
                    "sequence" : "3"                    
                },
                {
                    "task_number": "T1",
                    "src_task_number": "E1",
                    "taskNm": "Transform1",
                    "compNm": "RENAMEDFILE",
                    "columnList": "col1->col11,col2->col12,col3->col13",
                    "level" : "2",
                    "sequence" : "4"
                },
                {
                    "task_number": "T2",
                    "src_task_number": "E2,E3",
                    "taskNm": "Transform2",
                    "compNm": "RenamedTRF2",
                    "columnList": "col4->col14,col5,col6",
                    "level" : "2",
                    "sequence" : "5"
                    
                },
                {
                    "task_number": "T3",
                    "src_task_number": "T2,T1",
                    "taskNm": "Transform3",
                    "compNm": "TRF3",
                    "columnList": "col11,col12,col13,col14,col5,col6",
                    "level" : "3",
                    "sequence" : "6"                    

                },
                {
                    "task_number": "L1",
                    "src_task_number": "T3",
                    "taskNm": "Load",
                    "compNm": "FINAL",
                    "columnList": "col11,col12,col13,col14,col5,col6",
                    "level" : "4",
                    "sequence" : "7"
                }
            ]
        };

        function createTasks() {

            const positionMap = {
                "E1": { gridColumn: 1, gridRow: 1 },
                "E2": { gridColumn: 1, gridRow: 2 },
                "E3": { gridColumn: 1, gridRow: 3 },
                "T1": { gridColumn: 2, gridRow: 1 },
                "T2": { gridColumn: 2, gridRow: 2 },
                "T3": { gridColumn: 3, gridRow: 1 },
                "L1": { gridColumn: 4, gridRow: 1 }
            };


            const container = document.getElementById('lineage-container');
            lineageData.FILE_NAME.forEach(task => {
                const taskDiv = document.createElement('div');
                taskDiv.id = task.task_number;
                taskDiv.className = 'task-container';
                taskDiv.style.gridColumn = positionMap[task.task_number].gridColumn;
                taskDiv.style.gridRow = positionMap[task.task_number].gridRow;
                taskDiv.innerHTML = `
                    <h3>${task.task_number}: ${task.taskNm}</h3>
                    <p>Source Type: ${task.srcType || 'N/A'}</p>
                    <p>Component Name: ${task.compNm}</p>
                `;
                const columnList = task.columnList.split(',');
                columnList.forEach(column => {
                    const columnDiv = document.createElement('div');
                    columnDiv.className = 'column';
                    const [srcCol, destCol] = column.split('->');
                    columnDiv.textContent = destCol || srcCol;
                    columnDiv.setAttribute('data-src-col', srcCol);
                    columnDiv.setAttribute('data-dest-col', destCol || srcCol);
                    columnDiv.onclick = () => highlightLineage(columnDiv, task.task_number, srcCol, destCol);
                    taskDiv.appendChild(columnDiv);
                });
                container.appendChild(taskDiv);
            });
            drawTaskConnections();
        }

        function drawTaskConnections() {
            const svg = document.getElementById('connector-svg');
            const colors = ['#10b981', '#3b82f6', '#ef4444', '#f59e0b', '#8b5cf6'];
            let colorIndex = 0;
            lineageData.FILE_NAME.forEach(task => {
                if (task.src_task_number) {
                    const srcTasks = task.src_task_number.split(',');
                    srcTasks.forEach(srcTaskId => {
                        const srcElement = document.getElementById(srcTaskId);
                        const destElement = document.getElementById(task.task_number);
                        drawCurvedConnector(srcElement, destElement, 'task-connector', colors[colorIndex]);
                        colorIndex = (colorIndex + 1) % colors.length;
                    });
                }
            });
        }

        function highlightLineage(element, taskId, srcCol, destCol) {
            // Clear previous highlights
            document.querySelectorAll('.column').forEach(el => el.classList.remove('highlighted'));
            document.querySelectorAll('.task-container').forEach(el => el.classList.remove('task-highlighted'));
            document.querySelectorAll('.connector').forEach(el => el.remove());

            // Highlight the clicked column and its task
            element.classList.add('highlighted');
            document.getElementById(taskId).classList.add('task-highlighted');

            // Trace back to source
            traceLineageBack(taskId, srcCol);

            // Trace forward to destination
            traceLineageForward(taskId, destCol || srcCol);
        }

        function traceLineageBack(taskId, colName) {
            const task = lineageData.FILE_NAME.find(t => t.task_number === taskId);
            if (task.src_task_number) {
                const srcTasks = task.src_task_number.split(',');
                srcTasks.forEach(srcTaskId => {
                    const srcTask = lineageData.FILE_NAME.find(t => t.task_number === srcTaskId);
                    const srcColumns = srcTask.columnList.split(',');
                    srcColumns.forEach(srcCol => {
                        const [src, dest] = srcCol.split('->');
                        if (dest === colName || src === colName) {
                            const srcElement = document.querySelector(`#${srcTaskId} .column[data-src-col="${src}"]`);
                            if (srcElement) {
                                srcElement.classList.add('highlighted');
                                document.getElementById(srcTaskId).classList.add('task-highlighted');
                                drawCurvedConnector(srcElement, document.querySelector(`#${taskId} .column[data-dest-col="${colName}"]`));
                                traceLineageBack(srcTaskId, src);
                            }
                        }
                    });
                });
            }
        }

        function traceLineageForward(taskId, colName) {
            lineageData.FILE_NAME.forEach(task => {
                if (task.src_task_number && task.src_task_number.includes(taskId)) {
                    const destColumns = task.columnList.split(',');
                    destColumns.forEach(destCol => {
                        const [src, dest] = destCol.split('->');
                        if (src === colName || dest === colName) {
                            const destElement = document.querySelector(`#${task.task_number} .column[data-dest-col="${dest || src}"]`);
                            if (destElement) {
                                destElement.classList.add('highlighted');
                                document.getElementById(task.task_number).classList.add('task-highlighted');
                                drawCurvedConnector(document.querySelector(`#${taskId} .column[data-dest-col="${colName}"]`), destElement);
                                traceLineageForward(task.task_number, dest || src);
                            }
                        }
                    });
                }
            });
        }

        function drawCurvedConnector(from, to, className = 'connector', color = '#3b82f6') {
            const svg = document.getElementById('connector-svg');
            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            const fromRect = from.getBoundingClientRect();
            const toRect = to.getBoundingClientRect();
            const containerRect = document.getElementById('lineage-container').getBoundingClientRect();

            const x1 = fromRect.right - containerRect.left;
            const y1 = fromRect.top + fromRect.height / 2 - containerRect.top;
            const x2 = toRect.left - containerRect.left;
            const y2 = toRect.top + toRect.height / 2 - containerRect.top;

            const dx = Math.abs(x2 - x1) * 0.5;
            const dy = Math.random() * 50 - 25; // Random vertical offset for task connectors
            const d = className === 'task-connector' 
                ? `M${x1},${y1} C${x1+dx},${y1+dy} ${x2-dx},${y2-dy} ${x2},${y2}`
                : `M${x1},${y1} C${x1+dx},${y1} ${x2-dx},${y2} ${x2},${y2}`;

            path.setAttribute('d', d);
            path.setAttribute('class', className);
            path.setAttribute('stroke', color);
            svg.appendChild(path);
        }

        let currentZoom = 1;
        function zoomIn() {
            currentZoom *= 1.2;
            applyZoom();
        }

        function zoomOut() {
            currentZoom /= 1.2;
            applyZoom();
        }

        function resetZoom() {
            currentZoom = 1;
            applyZoom();
        }

        function applyZoom() {
            document.getElementById('lineage-container').style.transform = `scale(${currentZoom})`;
        }

        createTasks();
    </script>
</body>
</html>